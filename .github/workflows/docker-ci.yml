name: docker ci

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
    paths-ignore:
      - 'docs/**'
      - '**/*.md'
  pull_request:
    branches: [ main ]

permissions:
  contents: write
  packages: write
  id-token: write

env:
  DOTNET_NOLOGO: 1
  DOTNET_CLI_TELEMETRY_OPTOUT: 1
  NUGET_FEED: https://api.nuget.org/v3/index.json
  GITHUB_PACKAGES_FEED: https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json

jobs:
  build-and-test-and-pack:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Prepare NuGet cache directory
        run: mkdir -p ~/.nuget/packages

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/Directory.Packages.props', 'global.json') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Build image
        id: build-image
        env:
          TAG_NAME: ${{ github.ref_name }}
        run: |
          VERSION=""
          if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
            VERSION="${TAG_NAME#v}"
          fi
          docker build \
            --target build \
            -f docker/ci/Dockerfile.ci \
            -t hugo-ci \
            --build-arg PACKAGE_VERSION="${VERSION}" \
            . \
            --no-cache

      - name: Run Test in image
        id: test-image
        env:
          TAG_NAME: ${{ github.ref_name }}
        run: |
          VERSION=""
          if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
            VERSION="${TAG_NAME#v}"
          fi
          docker build \
            --target test \
            -f docker/ci/Dockerfile.ci \
            -t hugo-ci \
            --build-arg PACKAGE_VERSION="${VERSION}" \
            .

      - name: Pack nugets
        id: pack-image
        env:
          TAG_NAME: ${{ github.ref_name }}
        run: |
          VERSION=""
          if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
            VERSION="${TAG_NAME#v}"
          fi
          docker build \
            --target pack \
            -f docker/ci/Dockerfile.ci \
            -t hugo-ci \
            --build-arg PACKAGE_VERSION="${VERSION}" \
            .

      - name: Extract CI artifacts
        if: ${{ steps.build-image.outcome == 'success' }}
        id: extract-artifacts
        run: |
          container_id=$(docker create hugo-ci)
          echo "container_id=${container_id}" >> $GITHUB_OUTPUT
          mkdir -p artifacts/test-results artifacts/coverage artifacts/packages
          docker cp "${container_id}:/repo/artifacts/test-results/." artifacts/test-results || true
          docker cp "${container_id}:/repo/artifacts/coverage/." artifacts/coverage || true
          docker cp "${container_id}:/repo/artifacts/packages/." artifacts/packages || true
          docker rm "${container_id}" || true

      - name: Report test results
        if: ${{ always() && steps.extract-artifacts.outcome == 'success' }}
        uses: dorny/test-reporter@v2
        with:
          name: .NET Tests
          path: artifacts/test-results/**/*.trx
          reporter: dotnet-trx

      - name: Upload coverage to Codecov
        if: ${{ steps.extract-artifacts.outcome == 'success' }}
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: artifacts/coverage/**/*.xml
          fail_ci_if_error: false
          verbose: true

      - name: Upload Test Results
        if: ${{ steps.extract-artifacts.outcome == 'success' }}
        uses: actions/upload-artifact@v5
        with:
          name: test-results
          path: |
            artifacts/test-results/**/*.trx
          if-no-files-found: ignore

      - name: Upload Coverage Artifacts
        if: ${{ steps.extract-artifacts.outcome == 'success' }}
        uses: actions/upload-artifact@v5
        with:
          name: coverage
          path: artifacts/coverage
          if-no-files-found: ignore

      - name: Upload Package Artifacts
        if: ${{ steps.extract-artifacts.outcome == 'success' }}
        uses: actions/upload-artifact@v5
        with:
          name: packages
          path: artifacts/packages
          if-no-files-found: error

      - name: Setup .NET SDK for publishing
        if: ${{ steps.extract-artifacts.outcome == 'success' && github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v') }}
        uses: actions/setup-dotnet@v5
        with:
          global-json-file: global.json


      - name: Publish packages to NuGet.org
        if: ${{ steps.extract-artifacts.outcome == 'success' && github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v') }}
        env:
          NUGET_API_KEY: ${{ secrets.NUGET_TOKEN }}
        run: |
          set -euo pipefail
          shopt -s nullglob
          packages=(artifacts/packages/*.nupkg)
          if [[ ${#packages[@]} -eq 0 ]]; then
            echo "No packages found to push."
            exit 1
          fi
          for pkg in "${packages[@]}"; do
            if [[ "${pkg}" == *.snupkg ]]; then
              continue
            fi
            dotnet nuget push "${pkg}" \
              --source "${NUGET_FEED}" \
              --api-key "${NUGET_API_KEY}" \
              --skip-duplicate
          done
          symbol_packages=(artifacts/packages/*.snupkg)
          if [[ ${#symbol_packages[@]} -gt 0 ]]; then
            for pkg in "${symbol_packages[@]}"; do
              dotnet nuget push "${pkg}" \
                --source "${NUGET_FEED}" \
                --api-key "${NUGET_API_KEY}" \
                --skip-duplicate
            done
          fi

      - name: Publish packages to GitHub Packages
        if: ${{ steps.extract-artifacts.outcome == 'success' && github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          shopt -s nullglob
          packages=(artifacts/packages/*.nupkg)
          if [[ ${#packages[@]} -eq 0 ]]; then
            echo "No packages found to push."
            exit 1
          fi
          for pkg in "${packages[@]}"; do
            if [[ "${pkg}" == *.snupkg ]]; then
              continue
            fi
            dotnet nuget push "${pkg}" \
              --api-key "${GITHUB_TOKEN}" \
              --source "${GITHUB_PACKAGES_FEED}" \
              --skip-duplicate
          done

      - name: Create GitHub Release
        if: ${{ steps.extract-artifacts.outcome == 'success' && github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v') }}
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/packages/*.nupkg
            artifacts/packages/*.snupkg
          generate_release_notes: true
          fail_on_unmatched_files: true
