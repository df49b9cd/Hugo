# Hugo TaskQueue Control Plane Stories

This document breaks down three Hugo work items that emerged while examining how OmniRelay layers SafeTaskQueue-backed resource leasing, replication, and throttling in production (`src/OmniRelay/Dispatcher/ResourceLeaseDispatcher.cs:11-223`, `docs/reference/distributed-task-leasing.md:1-78`). Each story is structured with the artifacts engineering and QA teams need to plan, implement, and verify the enhancements before OmniRelay migrates from its bespoke dispatcher utilities.

## Story 2 – TaskQueue Replication Source & Deterministic Sink Helpers

### Goal
- Create a Hugo-level `TaskQueueReplicationSource` that emits ordered replication events, checkpointing sinks, and deterministic coordinators so OmniRelay (and other hosts) no longer need custom `ResourceLeaseReplicationEvent` plumbing (`src/OmniRelay/Dispatcher/ResourceLeaseReplication.cs:6-162`, `docs/reference/distributed-task-leasing.md:22-78`).

### Scope
- Covers replication for any `TaskQueue<T>`/`SafeTaskQueue<T>` mutation: enqueue, lease, heartbeat, ack, requeue, drain.
- Includes durable sink helpers (checkpointing, deterministic capture) but excludes persistence backends themselves (callers supply `IDeterministicStateStore`, blob, or DB writers).

### Requirements
1. Define a transport-neutral `TaskQueueReplicationEvent` record mirroring OmniRelay fields (sequence number, timestamp, peer/owner metadata, payload, error info) so migrations are mechanical.
2. Implement `TaskQueueReplicationSource` that subscribes to queue lifecycle hooks and emits ordered events via `IAsyncEnumerable<TaskQueueReplicationEvent>` or `ChannelWriter<TaskQueueReplicationEvent>`.
3. Provide `CheckpointingTaskQueueReplicationSink` base class replicating OmniRelay’s per-peer/global checkpoint tracking semantics to guarantee idempotent application even with retries (`src/OmniRelay/Dispatcher/ResourceLeaseReplication.cs:125-162`).
4. Ship deterministic helpers:
   - `TaskQueueDeterministicCoordinator` that wires events into `Hugo.DeterministicEffectStore` (see `docs/reference/deterministic-coordination.md:1-80`) and replays captured side effects.
   - JSON serialization context resolvers so hosts can persist events without hand-rolling contexts (`src/OmniRelay/Dispatcher/ResourceLeaseDeterministic.cs:9-133`).
5. Add hooks for replication lag metrics (sequence delta, wall-clock delta) and expose instrumentation consistent with `ResourceLeaseReplicationMetrics` in OmniRelay.

### Deliverables
- New Hugo package (e.g., `Hugo.TaskQueues.Replication`) containing the event contract, source, sinks, deterministic coordinator helpers, and serialization utilities.
- Documentation updates explaining replication wiring, deterministic replay, and peer checkpoint management (`docs/reference/hugo-api-reference.md` plus a dedicated reference page).
- Upgrade guidance for OmniRelay and other SafeTaskQueue adopters (sample code replacing `ResourceLeaseReplication*` types).
- Comprehensive automated tests and example integration harness.

### Acceptance Criteria
1. Replication events are strictly ordered, monotonic, and deduplicated within a single source even across concurrent queue operations.
2. Checkpointing sink correctly persists per-peer/global checkpoints and only forwards unseen events.
3. Deterministic coordinator captures payloads/events and can replay effects in failure/restart scenarios without duplicating work.
4. Metrics/tracing exported through `GoDiagnostics` align with OmniRelay’s current `omnirelay.resourcelease.replication.*` signals so dashboards stay intact.
5. Migration spike demonstrates OmniRelay can remove `ResourceLeaseReplication*` and `ResourceLeaseDeterministic*` files after adopting the Hugo package.

### References
- `src/OmniRelay/Dispatcher/ResourceLeaseReplication.cs:6-162` – current replication event contract + checkpointing logic.
- `src/OmniRelay/Dispatcher/ResourceLeaseDeterministic.cs:9-133` – deterministic coordinator + serializer context.
- `docs/reference/distributed-task-leasing.md:22-78` – replication stream rationale and operator guidance.
- `docs/reference/deterministic-coordination.md:1-80` – Hugo deterministic primitives to integrate.

### Testing Strategy
- Blend unit tests for event sequencing, serialization, and checkpoint math with integration tests that replay real queue workloads and feature tests that persist/replay through deterministic stores.
- Include chaos/resilience tests (simulated crashes) to validate idempotency and checkpoint recovery.

### Unit Test Scenarios
- Verify `TaskQueueReplicationEvent.Create` enforces incremental sequence numbers and populates timestamps with `TimeProvider`.
- Test checkpoint dictionary logic under concurrent event application; ensure per-peer checkpoints update independently.
- Confirm deterministic coordinator picks the correct `JsonSerializerContext` based on options (mirroring OmniRelay helper).

### Integration Test Scenarios
- Run a `TaskQueueReplicationSource` against an in-memory queue, enqueue + lease + ack items, and assert downstream sink receives ordered events even with parallel consumers.
- Simulate sink restarts with persisted checkpoints to ensure replay resumes from the correct sequence.
- Connect deterministic coordinator to `InMemoryDeterministicStateStore` (from tests/TestSupport) and validate recorded events can be replayed to rehydrate state.

### Feature Test Scenarios
- Deploy OmniRelay sample cluster using the Hugo replication source; verify peers subscribe to the stream over HTTP/gRPC and maintain consistent lease state.
- Drive failover scenario (kill active owner mid-lease) to confirm replication + deterministic capture provide enough data for audit trails and replays.
- Compare metrics emitted before/after migration to ensure `replication.events` counters and lag histograms remain accurate.
