# Hugo TaskQueue Control Plane Stories

This document breaks down three Hugo work items that emerged while examining how OmniRelay layers SafeTaskQueue-backed resource leasing, replication, and throttling in production (`src/OmniRelay/Dispatcher/ResourceLeaseDispatcher.cs:11-223`, `docs/reference/distributed-task-leasing.md:1-78`). Each story is structured with the artifacts engineering and QA teams need to plan, implement, and verify the enhancements before OmniRelay migrates from its bespoke dispatcher utilities.

## Story 3 – TaskQueue Observability & Diagnostics Package

### Goal
- Bundle TaskQueue-specific metrics, tracing, and diagnostics under Hugo so operators can enable standardized instrumentation (meters, ActivitySources, sampling utilities) instead of maintaining OmniRelay-only code paths (`docs/reference/hugo-api-reference.md:85-166`, `src/OmniRelay/Dispatcher/ResourceLeaseDispatcher.cs:520-638`).

### Scope
- Covers metrics/trace exporters, diagnostic listeners, and helper middleware for SafeTaskQueue-driven workflows (resource leasing, replication, throttling).
- Excludes vendor-specific exporters; the package should integrate with .NET `IMeterFactory`/`ActivitySource` registration patterns already documented in Hugo.

### Requirements
1. Define `Hugo.TaskQueues.Diagnostics` with:
   - `TaskQueueMetricsOptions` (enable/disable groups, configure histogram buckets, tag enrichers).
   - Default meters/counters for pending depth, active leases, throughput, replication lag, backpressure transitions (align with OmniRelay metrics in `docs/reference/distributed-task-leasing.md:60-78`).
2. Expose `ActivitySource` helpers + `UseRateLimitedSampling` shortcuts tailored for TaskQueue operations (building on `UseRateLimitedSampling` in `docs/reference/hugo-api-reference.md:160-163`).
3. Provide instrumentation middleware/adapters so `TaskQueueBackpressureMonitor` and `TaskQueueReplicationSource` automatically emit diagnostics when registered (zero-boilerplate).
4. Offer `TaskQueueDiagnosticsHost` sample that wires meters, activity sources, rate-limited sampling, and resets for unit tests (similar to OmniRelay’s `ResourceLeaseBackpressureDiagnosticsListener` control endpoint usage).
5. Document recommended dashboard queries + alerts referencing OmniRelay’s HTTP/gRPC control-plane endpoints.

### Deliverables
- New diagnostics namespace with extension methods (`AddTaskQueueDiagnostics`, `ConfigureTaskQueueMeters`, etc.).
- Updated reference docs plus runnable sample (could extend `samples/ResourceLease.MeshDemo` to consume the package).
- Instrumentation guidelines for OmniRelay maintainers describing migration steps.
- Associated unit/integration/feature tests.

### Acceptance Criteria
1. Calling `AddTaskQueueDiagnostics` registers meters/activity sources and returns disposable handles consistent with `GoDiagnostics` setup guidance.
2. Metrics cover pending depth, active leases, replication events, lag, and backpressure transitions with consistent tag sets (service, queue name, shard).
3. Activity sampling respects rate limits and integrates with .NET 10 sampling guidance (per `docs/reference/hugo-api-reference.md:160-163`).
4. Sample/control endpoint demonstrates streaming diagnostics (leveraging diagnostics listener) and can be consumed by CLI “watch” commands.
5. OmniRelay telemetry dashboards ingest the new instruments without schema changes (documented via rollout notes).

### References
- `docs/reference/hugo-api-reference.md:85-166` – existing Go diagnostics + sampling APIs to extend.
- `docs/reference/distributed-task-leasing.md:60-78` – metrics currently emitted for resource lease backpressure/replication.
- `samples/ResourceLease.MeshDemo/Program.cs:63-188` – control-plane endpoint exposing diagnostics stream today.
- `src/OmniRelay/Dispatcher/ResourceLeaseDispatcher.cs:520-638` – replication publish path that logs metrics manually.

### Testing Strategy
- Validate instruments via unit tests that assert meter counters/histograms receive expected values after simulated queue operations.
- Integration tests should host a minimal worker, register diagnostics, and scrape metrics over `MeterListener` or OTLP exporters.
- Feature tests cover full OmniRelay sample mesh, verifying CLI/watch endpoints and Activity sampling toggles.

### Unit Test Scenarios
- Register diagnostics in isolation, simulate backpressure transitions, and confirm counters/histograms increment with correct tags.
- Ensure `UseRateLimitedSampling` returns `IDisposable` handle and toggles `ActivityListener` sampling rates as configured.
- Validate disposal/reset helpers clean up meters and listeners (matching `Diagnostics.Reset()` semantics in `docs/reference/hugo-api-reference.md:163`).

### Integration Test Scenarios
- Hook diagnostics into a hosted `TaskQueueBackpressureMonitor` + `TaskQueueReplicationSource`, run queue workload, and capture metrics via `MeterListener` to assert instrument names/values.
- Exercise Activity sampling with OpenTelemetry exporter to confirm spans respect max-per-interval quotas.
- Extend the mesh sample to expose `/diagnostics/taskqueue` endpoint and verify SSE/gRPC clients can stream metrics/backpressure events together.

### Feature Test Scenarios
- Deploy OmniRelay in a containerized environment using the diagnostics package, run hyperscale load (HTTP/gRPC), and compare dashboards before/after enabling the new metrics.
- Execute failure drills (queue jam, replication lag spike) and ensure alerts fire using the new instruments.
- Validate CLI `omnirelay control watch backpressure` (or equivalent) continues to work when pointing at Hugo-provided diagnostics endpoints.

### Implementation status (Nov 2025)
- `src/Hugo.TaskQueues.Diagnostics` ships `TaskQueueMetricsOptions`, `TaskQueueDiagnosticRegistration`, `TaskQueueDiagnosticsHost`, and the `IMeterFactory.AddTaskQueueDiagnostics(...)` extensions that satisfy requirements 1â€“3.
- `docs/reference/diagnostics.md`, `docs/how-to/taskqueue-diagnostics.md`, and `docs/reference/api-reference.md` describe the new APIs, dashboard queries, and OmniRelay rollout steps.
- `samples/Hugo.TaskQueueDiagnosticsHostSample` exposes a runnable SSE control-plane endpoint that consumes `TaskQueueDiagnosticsHost` and validates the streaming diagnostics path end-to-end.

